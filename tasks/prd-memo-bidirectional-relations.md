# PRD: Memo 双向关联展示功能

## Introduction

当前 Memos 的"相关笔记"弹窗仅展示基于向量相似度的语义搜索结果。用户需要看到完整的关联关系：**当前笔记关联了哪些笔记**（主动关联，已存在于 `relations` 字段）以及**被哪些笔记关联**（被动关联，需要新增查询），帮助用户更好地导航知识网络。

## Goals

- 在相关笔记弹窗中清晰区分三种关系类型：语义相似、主动关联（relations）、被关联（backlinks）
- 支持双向导航：从任一笔记跳转到其关联笔记
- 保持现有语义搜索功能不受影响
- 复用现有 `relations` 数据，无需修改现有接口

## User Stories

### US-001: 新增获取反向关联的 API 接口
**Description:** 作为开发者，我需要一个 API 来查询哪些笔记关联了当前笔记，以便前端展示完整的双向关系。

**Acceptance Criteria:**
- [ ] 新增 `GET /api/v1/memos/:id/backlinks` 接口，返回引用当前笔记的笔记列表
- [ ] 接口返回字段：id, content, creator, createdAt, updatedAt
- [ ] 支持分页参数：page, limit（默认 limit=20）
- [ ] 接口需要 JWT 认证，只返回用户有权限查看的笔记
- [ ] 包含对应的单元测试
- [ ] Typecheck/lint passes

### US-002: 重构相关笔记弹窗为三栏标签页布局
**Description:** 作为用户，我希望在一个弹窗中看到语义相关、主动关联、被关联三种笔记，方便全面了解知识关系。

**Acceptance Criteria:**
- [ ] 弹窗使用标签页(Tabs)布局，包含三个选项：
  - "语义相关"（现有功能，基于向量相似度）
  - "关联了"（当前笔记主动关联的其他笔记，来自现有 `relations` 字段）
  - "被关联"（引用当前笔记的其他笔记，调用新增 backlinks API）
- [ ] 每个标签页显示对应的笔记列表，展示：内容摘要、创建时间
- [ ] "关联了"标签页直接使用 memo 详情中已有的 `relations` 数据，无需额外请求
- [ ] "被关联"标签页调用 US-001 新增的 backlinks 接口获取数据
- [ ] 点击笔记卡片可跳转到对应笔记详情
- [ ] 空状态显示友好提示（如"暂无关联笔记"）
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-003: 新增关联图谱视图
**Description:** 作为用户，我希望以图谱形式可视化查看笔记间的关联关系，直观理解知识网络。

**Acceptance Criteria:**
- [ ] 在"相关笔记"弹窗中新增第四个标签页"关联图谱"
- [ ] 使用力导向图(force-directed graph)展示：
  - 当前笔记作为中心节点（高亮显示）
  - 主动关联的笔记（来自 `relations`）作为子节点，连线用蓝色/实线箭头指向目标
  - 被关联的笔记（来自 backlinks API）作为父节点，连线用绿色/虚线箭头指向当前笔记
  - 语义相关笔记可选显示为灰色节点
- [ ] 支持交互：拖拽节点、缩放画布、点击节点跳转详情
- [ ] 节点显示笔记标题/内容前30字
- [ ] 限制图谱显示节点总数不超过 50 个（优先显示主动关联和被关联，语义相关按需加载）
- [ ] 响应式设计，适配移动端
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

## Functional Requirements

### 后端 API

- **FR-1:** 新增 `GET /api/v1/memos/:id/backlinks` 接口
  - 查询所有引用了当前笔记 ID 的其他笔记
  - 返回数组包含：id, content（截断前200字符）, creator, createdAt, updatedAt
  - 支持分页，默认 limit=20，最大 limit=100
  - 需要 JWT 认证，只返回当前用户可见的笔记

- **FR-2:** 关联数据查询实现
  - 反向关联通过查询其他 memo 的 `linkedMemoIds`（或 `relations` 关联表）包含当前 ID 来实现
  - 如果数据量大，考虑添加反向索引表优化查询性能（可选优化项）

### 前端 UI

- **FR-3:** 相关笔记弹窗使用标签页布局
  - Tab 1: "语义相关" - 现有相似度搜索结果
  - Tab 2: "关联了" - 当前笔记主动关联的其他笔记（直接使用 memo.relations）
  - Tab 3: "被关联" - 引用当前笔记的其他笔记（调用 backlinks API）
  - Tab 4: "关联图谱" - 可视化展示双向关系

- **FR-4:** 关联图谱功能
  - 使用 D3.js 或 ECharts 实现力导向图
  - 节点区分：当前笔记（主色高亮）、主动关联（蓝色）、被关联（绿色）
  - 支持最小缩放、适应屏幕、点击跳转
  - 提供图例说明不同颜色/线型的含义

## Non-Goals

- 不修改关联创建方式（保持现有手动关联逻辑不变）
- 不修改现有接口返回的数据结构（relations 字段保持不变）
- 不添加笔记列表的关联数量指示器（暂时不需要）
- 不添加自动关联推荐功能
- 不实现图谱的批量编辑功能（仅查看）

## Design Considerations

### UI 布局建议

```
┌─────────────────────────────────────────────────────┐
│  相关笔记                                    [×]    │
├─────────────────┬───────────────────────────────────┤
│                 │                                   │
│  [语义相关]      │   笔记列表内容区 / 图谱画布          │
│  [关联了]        │                                   │
│  [被关联]        │   ─────────────────────           │
│  [关联图谱]      │   内容摘要...                      │
│                 │   创建于 2024-01-15               │
│                 │   ─────────────────────           │
│                 │   内容摘要...                      │
│                 │   创建于 2024-01-14               │
│                 │                                   │
│                 │   [加载更多]                      │
│                 │                                   │
├─────────────────┴───────────────────────────────────┤
│  共 12 条结果                                        │
└─────────────────────────────────────────────────────┘
```

### 标签页说明

| 标签页 | 数据来源 | 显示内容 |
|-------|---------|---------|
| 语义相关 | 现有相似度搜索 API | 基于向量相似度的相关笔记 |
| 关联了 | memo.relations | 当前笔记主动关联的其他笔记 |
| 被关联 | 新增 backlinks API | 引用当前笔记的其他笔记 |
| 关联图谱 | relations + backlinks | 力导向图可视化展示 |

### 组件复用

- 复用现有的 `RelatedMemosModal` 组件进行扩展
- 复用 `MemoCard` 或创建 `SimpleMemoCard` 组件展示关联笔记列表
- 新增 `RelationGraph` 组件用于图谱视图（基于 D3.js 或 ECharts）
- 新增 `backlinks` API 调用方法在 `memo.service.ts`

## Technical Considerations

### 后端查询实现

反向关联查询实现方式：
- 如果 memo 表有 `linkedMemoIds` JSON 数组字段：使用 `WHERE linkedMemoIds LIKE '%"memoId"%'` 或数据库特定的 JSON 查询
- 如果是关联表（如 `memo_relations`）：查询 `WHERE targetMemoId = :id`
- 注意性能：如果数据量大，考虑添加反向索引表优化

### 前端状态管理

- 在 `MemoService` 中新增方法：`fetchBacklinks(memoId, page?, limit?)`
- 在 `RelatedMemosModal` 组件中管理三个标签页的状态
- 缓存策略：backlinks 数据在标签页切换时加载，关闭弹窗后清除

### 图谱性能

- 限制图谱显示节点数量：最多显示 50 个关联笔记
- 优先级：主动关联 > 被关联 > 语义相关
- 使用 Canvas 或 WebGL 渲染（ECharts 支持）保证大量节点时的流畅性

## Success Metrics

- 用户可以在 2 步内查看任意笔记的双向关联
- 关联信息加载时间 < 500ms（单笔记 backlinks 查询）
- 图谱交互流畅，FPS > 30

## Open Questions

1. 反向关联查询是否需要权限过滤？（例如：笔记 A 关联了笔记 B，但当前用户无权查看笔记 A）
2. 语义相关笔记和主动关联笔记可能出现重复，是否需要去重或在标签页间做标记？
3. 关联图谱中，如果主动关联和被关联有循环引用（A→B→A），如何处理节点去重？
4. backlinks 接口的分页策略：是否需要支持排序（按创建时间、按更新时间）？
