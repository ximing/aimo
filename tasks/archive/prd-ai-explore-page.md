# PRD: AI 探索页面（AI Explore Page）

## Introduction

AI探索页面是一个基于大模型的智能知识发现界面，用户可以像与专家对话一样，基于自己已有的笔记进行提问、探索和分析。系统利用LangChain DeepAgents技术，自动检索相关笔记、分析笔记间关系、理解附件内容，并以自然对话的形式给出有来源可追溯的智能回答。

这个页面解决了用户面对大量笔记时难以发现关联、难以快速获取洞察的问题，将静态的笔记库转化为可交互的知识助手。

## Goals

- 提供自然语言对话界面，让用户可以基于全库笔记进行自由提问
- 自动检索相关笔记内容、关系和附件，作为回答依据
- 每个AI回答都必须标明来源笔记，确保可追溯性
- 帮助用户发现笔记间的隐藏联系和知识盲区
- 支持多轮对话，保持上下文连贯性
- 响应时间控制在3-5秒内（不含大模型生成时间）

## User Stories

### US-001: 对话界面基础架构
**Description:** 作为用户，我需要一个对话式界面来与AI交互，以便自然地提出关于我笔记的问题。

**Acceptance Criteria:**
- [ ] 页面包含可滚动的消息历史区域
- [ ] 底部有固定输入框，支持多行文本
- [ ] 输入框有发送按钮（支持Enter快捷键发送）
- [ ] 用户消息和AI消息有明显视觉区分
- [ ] 支持Markdown渲染AI回复内容
- [ ] 空状态显示引导性提示语（如"问我关于你的笔记任何问题..."）
- [ ] 支持对话历史清空功能
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-002: LangChain DeepAgents后端架构
**Description:** 作为开发者，我需要搭建基于LangChain的DeepAgents架构，以便智能处理用户查询。

**Acceptance Criteria:**
- [ ] 设计并实现多Agent协作架构：
  - `检索Agent`：负责向量搜索相关笔记
  - `关系分析Agent`：分析笔记间的关联关系
  - `附件理解Agent`：提取图片/文件关键信息
  - `总结Agent`：整合信息生成最终回答
- [ ] 使用LangChain的Tool/Function Calling机制
- [ ] 实现Agent间的状态传递和上下文管理
- [ ] 配置DeepSeek/OpenAI等大模型接入
- [ ] 实现Agent执行日志，便于调试
- [ ] Typecheck/lint passes

### US-003: 智能检索与来源标注
**Description:** 作为用户，我希望AI回答能显示引用了哪些笔记，以便验证信息来源。

**Acceptance Criteria:**
- [ ] AI回答中引用的笔记以卡片形式展示在回答下方
- [ ] 每个来源卡片显示：笔记标题、摘要、相似度分数
- [ ] 点击来源卡片可跳转到对应笔记详情
- [ ] 回答正文中的引用以[1]、[2]等形式标注，可点击跳转
- [ ] 当没有相关笔记时，AI明确告知"基于现有笔记无法回答"
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-004: 笔记关系图谱探索
**Description:** 作为用户，我希望AI能发现并展示笔记间的关联关系，以便理解知识结构。

**Acceptance Criteria:**
- [ ] AI能识别并描述笔记间的主题关联、时间关联、标签关联
- [ ] 在回答中可选显示关系图谱小部件（3-5个关联笔记）
- [ ] 关系图谱支持点击节点查看笔记详情
- [ ] 提供"探索相关"按钮，基于当前话题深入探索
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-005: 附件内容理解
**Description:** 作为用户，我希望AI能理解和引用图片、PDF等附件内容，以便全面利用我的资料。

**Acceptance Criteria:**
- [ ] 支持图片附件：AI能描述图片内容并作为回答依据
- [ ] 支持PDF/文本附件：AI能提取关键信息
- [ ] 附件来源在回答中明确标注
- [ ] 附件预览可直接在页面中查看
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-006: 多轮对话与上下文记忆
**Description:** 作为用户，我希望能进行追问和深入交流，以便逐步探索问题。

**Acceptance Criteria:**
- [ ] 支持多轮对话，AI能记住之前的上下文
- [ ] 显示对话轮次指示器
- [ ] 支持"新建话题"按钮开启独立对话
- [ ] 对话历史存储在本地，刷新不丢失
- [ ] 单次对话限制10轮，超出时提示新建话题
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

### US-007: 探索建议和洞察生成
**Description:** 作为用户，我希望AI能主动给我洞察和建议，以便发现知识盲区。

**Acceptance Criteria:**
- [ ] 提供"发现洞察"功能按钮
- [ ] AI分析全库笔记后生成：主题聚类、时间趋势、关联建议
- [ ] 洞察报告以结构化形式展示（分类、标签云、时间线）
- [ ] 支持"告诉我更多"追问深入特定主题
- [ ] Typecheck/lint passes
- [ ] Verify in browser using dev-browser skill

## Functional Requirements

### 核心对话功能
- FR-1: 页面必须提供类似ChatGPT的对话界面，用户输入自然语言问题
- FR-2: 系统必须使用LangChain DeepAgents处理用户查询
- FR-3: AI响应必须基于用户实际存在的笔记内容，不得 hallucinate
- FR-4: 每个AI回答必须附带来源笔记引用（至少1个，最多5个）
- FR-5: 来源引用必须包含笔记标题、内容摘要、相似度分数
- FR-6: 点击来源引用必须能打开对应笔记详情页

### Agent架构
- FR-7: 系统必须实现检索Agent，使用LanceDB向量搜索相关笔记
- FR-8: 系统必须实现关系分析Agent，查询笔记间的关联关系
- FR-9: 系统必须实现附件理解Agent，提取图片/PDF的关键信息
- FR-10: 系统必须实现总结Agent，整合各Agent输出生成最终回答
- FR-11: Agent间必须通过共享状态传递中间结果
- FR-12: 整个Agent链执行时间不得超过5秒（不含LLM生成）

### 数据集成
- FR-13: 检索范围必须包括：笔记标题、内容、标签
- FR-14: 检索范围必须包括：笔记间的relation关系
- FR-15: 检索范围必须包括：附件的元数据和提取的文本/描述
- FR-16: 向量搜索返回Top 10相关笔记，由总结Agent筛选最相关的5个

### UI/UX
- FR-17: AI回答必须使用流式输出（打字机效果）
- FR-18: 必须显示AI正在"思考中"的状态指示器
- FR-19: 必须支持对话历史清空和新建话题
- FR-20: 必须支持追问，保持多轮对话上下文
- FR-21: 空状态必须显示示例问题引导用户

### 性能与限制
- FR-22: 单次对话最多10轮，超出必须提示新建话题
- FR-23: 用户输入限制500字符
- FR-24: AI回答限制2000字符
- FR-25: 对话历史存储在localStorage，最多保留10个话题

## Non-Goals (Out of Scope)

- 不支持修改笔记内容（仅只读探索）
- 不支持跨用户数据访问（严格隔离）
- 不支持实时同步（页面刷新后需重新加载）
- 不支持语音输入/输出（仅文本）
- 不支持导出对话记录（后续版本考虑）
- 不支持自定义Agent行为（使用预设架构）
- 不支持离线使用（需要调用大模型API）

## Design Considerations

### 界面布局
```
+--------------------------------------------------+
|  AI 探索                                          |
+--------------------------------------------------+
|                                                  |
|  +--------------------------------------------+  |
|  |  🤖 你好！我是你的笔记助手。问我任何关于    |  |
|  |     你笔记的问题，我会基于你的记录回答。    |  |
|  +--------------------------------------------+  |
|                                                  |
|  +----------------------------------------+      |
|  | 用户：最近有什么重要想法？              |      |
|  +----------------------------------------+      |
|                                                  |
|  +----------------------------------------+      |
|  | 🤖 根据你的笔记，最近你在思考...        |      |
|  |                                         |      |
|  | 来源：                                  |      |
|  | [📄 产品思路笔记] [📄 会议记录]        |      |
|  +----------------------------------------+      |
|                                                  |
+--------------------------------------------------+
|  问我任何问题...                    [发送]       |
+--------------------------------------------------+
```

### 现有组件复用
- 使用已有的`memo-card`组件展示来源笔记
- 复用`loading-spinner`组件作为思考指示器
- 复用`markdown-renderer`渲染AI回答

### 新增组件
- `chat-message`：对话消息气泡组件
- `source-citation`：来源引用卡片组件
- `explore-input`：底部输入框组件
- `relation-mini-graph`：迷你关系图谱组件

## Technical Considerations

### LangChain架构建议
```
用户查询
    ↓
[Supervisor Agent] ← 协调各Agent
    ↓
┌─────────────┬─────────────┬─────────────┐
↓             ↓             ↓             ↓
[检索Agent] [关系Agent] [附件Agent] [历史Agent]
    ↓             ↓             ↓             ↓
笔记内容    关联关系    附件信息    对话上下文
    └─────────────┴─────────────┴─────────────┘
                    ↓
            [总结Agent]
                    ↓
            最终回答 + 来源标注
```

### 依赖项
- `langchain` - Agent框架核心
- `@langchain/openai` 或 `@langchain/deepseek` - 模型接入
- 复用现有`lancedb`服务进行向量检索

### 集成点
- 复用现有的`SearchService.semanticSearch()`进行笔记检索
- 复用`MemoRelationService`获取笔记关系
- 复用`AttachmentService`获取附件信息
- 新增`ExploreService`协调整个Agent流程

### 性能优化
- Agent并行执行：检索Agent、关系Agent、附件Agent可并行
- 使用LangChain的RunnableParallel实现并发
- 向量搜索结果缓存（5分钟）
- 对话上下文压缩（超过5轮时总结历史）

## Success Metrics

- 用户平均每次会话提问3次以上（表明有追问价值）
- AI回答的来源准确率达到90%以上（随机抽查）
- 平均响应时间（Agent执行+LLM生成）< 10秒
- 用户主动使用"发现洞察"功能的频率 > 20%
- 页面留存时间比普通笔记页面高50%

## Open Questions

1. 是否需要支持用户反馈（点赞/点踩AI回答）？
2. 是否需要支持保存有价值的对话为笔记？
3. 多Agent架构是否会增加过多复杂度？是否需要先单Agent MVP？
4. 附件理解（特别是图片）是否需要额外的Vision模型成本考虑？
5. 是否需要支持用户选择探索范围（特定标签/时间范围）？
