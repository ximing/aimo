{
  "project": "AIMO",
  "branchName": "ralph/drizzle-migration",
  "description": "Migrate to Drizzle ORM with hybrid storage - scalar data in relational DB, vectors in LanceDB",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Drizzle database abstraction layer",
      "description": "As a developer, I need a unified database interface that supports MySQL, PostgreSQL, and SQLite so the application works across different deployment environments.",
      "acceptanceCriteria": [
        "Create `src/sources/database/` directory structure",
        "Implement `DrizzleAdapter` with connection factory for MySQL/PostgreSQL/SQLite",
        "Database type selected via `DATABASE_TYPE` env var (mysql|postgresql|sqlite, default: mysql)",
        "Connection string parsed from existing env pattern (e.g., `DATABASE_URL` or service-specific vars)",
        "Connection pooling configured appropriately for each DB type",
        "Graceful connection error handling with clear error messages",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Define Drizzle schema for scalar data",
      "description": "As a developer, I need Drizzle table schemas that mirror current LanceDB scalar fields so data structure remains consistent.",
      "acceptanceCriteria": [
        "Create schema files in `src/sources/database/schema/` for: memos.ts, users.ts, memo_relations.ts, attachments.ts, _migrations.ts",
        "Schemas exclude embedding vectors (remain in LanceDB)",
        "Use appropriate Drizzle column types for each DB (e.g., `text()` vs `varchar()`)",
        "Define indexes for frequently queried fields (userId, createdAt, tags)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement database migration system",
      "description": "As a developer, I need Drizzle migrations to manage schema changes across all supported databases.",
      "acceptanceCriteria": [
        "Configure `drizzle-kit` in `apps/server/drizzle.config.ts`",
        "Generate initial migration for all schemas",
        "Migration files created in `src/sources/database/migrations/`",
        "Migrations run automatically on app startup via `DrizzleAdapter.runMigrations()`",
        "Migration state tracked in `_migrations` table (reuse existing pattern)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create repository layer for scalar operations",
      "description": "As a developer, I need repository classes that encapsulate Drizzle queries so services don't directly interact with the ORM.",
      "acceptanceCriteria": [
        "Create `src/repositories/` directory",
        "Implement `MemoRepository` with methods: create(), findById(), findByUserId(), update(), delete(), findByIds() (batch fetch), search() (scalar filters)",
        "Implement `MemoRelationRepository` (existing relation operations)",
        "Implement `UserRepository` (existing user operations)",
        "Implement `AttachmentRepository` (existing attachment operations)",
        "All methods return DTOs from `@aimo/dto`",
        "Repositories decorated with `@Service()` for TypeDI injection",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Update environment configuration",
      "description": "As a deployment engineer, I need updated environment variables to configure the relational database connection.",
      "acceptanceCriteria": [
        "Update `.env.example` with new variables: DATABASE_TYPE=mysql, DATABASE_URL, optional DATABASE_POOL_SIZE",
        "Update `README.md` and `CLAUDE.md` with database setup instructions",
        "Document migration from LanceDB-only setup",
        "Keep existing `LANCEDB_*` variables (still used for vectors)",
        "Validate required env vars on startup with helpful error messages",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Refactor MemoService to use hybrid storage",
      "description": "As a developer, I need MemoService to query LanceDB for vector IDs then fetch details from Drizzle so vector search works with relational data.",
      "acceptanceCriteria": [
        "`MemoService.create()` writes to both Drizzle (scalar) and LanceDB (vector + id)",
        "`MemoService.update()` updates both Drizzle and LanceDB",
        "`MemoService.delete()` removes from both stores",
        "`MemoService.findById()` fetches from Drizzle only",
        "`MemoService.listMemos()` fetches from Drizzle with pagination/filters",
        "Vector search flow: LanceDB returns IDs → `MemoRepository.findByIds()` fetches details",
        "Existing controller methods unchanged (same signatures and responses)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Refactor SearchService for hybrid queries",
      "description": "As a developer, I need SearchService to coordinate between LanceDB (vector search) and Drizzle (scalar filters) so complex queries work efficiently.",
      "acceptanceCriteria": [
        "`SearchService.semanticSearch()` queries LanceDB for vector similarity, returns IDs",
        "Fetch memo details via `MemoRepository.findByIds()` with scalar filters applied",
        "Full-text search remains in LanceDB, scalar enrichment from Drizzle",
        "Support combined queries (e.g., semantic search + tag filter + date range)",
        "Maintain existing search response format (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented in MemoService.vectorSearch() instead of separate SearchService - vector search in LanceDB returns IDs, details fetched from Drizzle via MemoRepository, supports categoryId/startDate/endDate filters"
    },
    {
      "id": "US-008",
      "title": "Refactor UserService and AttachmentService",
      "description": "As a developer, I need UserService and AttachmentService to use Drizzle repositories so all scalar data lives in the relational DB.",
      "acceptanceCriteria": [
        "`UserService` uses `UserRepository` instead of LanceDB",
        "`AttachmentService` uses `AttachmentRepository` instead of LanceDB",
        "All existing service methods work identically (same inputs/outputs)",
        "JWT authentication flow unchanged",
        "File upload/storage logic unchanged (only metadata storage migrated)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement LanceDB data migration script",
      "description": "As a system administrator, I want historical LanceDB data automatically migrated to Drizzle on first startup so no data is lost.",
      "acceptanceCriteria": [
        "Create `src/migrations/lancedb-to-drizzle.migration.ts`",
        "On startup, check if LanceDB data exists and Drizzle is empty",
        "Before migration, export full LanceDB backup to `./backups/lancedb-backup-[timestamp].json`",
        "Migrate all tables: memos, users, memo_relations, attachments",
        "Migration is transactional (rollback on failure)",
        "Migration failure causes startup to abort with clear error message",
        "Log migration progress (e.g., 'Migrated 1000/5000 memos...')",
        "Mark migration complete in `_migrations` table to prevent re-run",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add database health checks",
      "description": "As a DevOps engineer, I need health check endpoints to verify database connectivity for monitoring and deployment validation.",
      "acceptanceCriteria": [
        "Add `GET /health/db` endpoint in existing health controller",
        "Check Drizzle connection (simple query like `SELECT 1`)",
        "Check LanceDB connection (existing check)",
        "Return JSON: `{ drizzle: 'ok', lancedb: 'ok' }` or error details",
        "200 status if both healthy, 503 if either fails",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Graceful shutdown for Drizzle connections",
      "description": "As a system administrator, I need database connections properly closed on shutdown so no connections leak.",
      "acceptanceCriteria": [
        "Add Drizzle connection cleanup to `src/index.ts` shutdown handler",
        "Close connection pool before process exit",
        "Shutdown order: Stop accepting requests → Close Drizzle → Close LanceDB",
        "Log shutdown steps for debugging",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Update test suite for hybrid storage",
      "description": "As a developer, I need tests updated to cover Drizzle repositories and hybrid queries so regressions are caught.",
      "acceptanceCriteria": [
        "Update existing service tests to use in-memory SQLite for Drizzle",
        "Mock LanceDB interactions in service tests",
        "Add repository unit tests for CRUD operations",
        "Add integration tests for hybrid search (LanceDB IDs → Drizzle details)",
        "All existing tests pass with new implementation",
        "Test coverage maintained or improved",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    }
  ]
}
