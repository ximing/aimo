{
  "project": "AIMO",
  "branchName": "ralph/complete-drizzle-migration",
  "description": "Complete Drizzle migration for remaining schemas - categories, tags, AI conversations, push rules, daily recommendations",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Drizzle schemas for categories and tags",
      "description": "As a developer, I need Drizzle schemas for categories and tags so users can organize their memos.",
      "acceptanceCriteria": [
        "Create `src/sources/database/schema/categories.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: categoryId (PK), uid, name, color, createdAt, updatedAt",
        "Create `src/sources/database/schema/tags.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: tagId (PK), uid, name, color, usageCount, createdAt, updatedAt",
        "Add indexes for uid field in both tables (no foreign keys)",
        "Export schemas and types from `src/sources/database/schema/index.ts`",
        "Update schema helper functions (getCategoriesTable, getTagsTable)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create Drizzle schemas for AI conversations and messages",
      "description": "As a developer, I need Drizzle schemas for AI conversations and messages so the chat feature works with relational DB.",
      "acceptanceCriteria": [
        "Create `src/sources/database/schema/ai-conversations.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: conversationId (PK), uid, title, createdAt, updatedAt",
        "Create `src/sources/database/schema/ai-messages.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: messageId (PK), conversationId, role, content, sources (JSON text), createdAt",
        "Add indexes for uid (conversations) and conversationId (messages) - no foreign keys",
        "Sources stored as JSON string (serialize/deserialize AIMessageSource[])",
        "Export schemas and types from `src/sources/database/schema/index.ts`",
        "Update schema helper functions (getAIConversationsTable, getAIMessagesTable)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create Drizzle schemas for push rules and daily recommendations",
      "description": "As a developer, I need Drizzle schemas for push rules and daily recommendations so notification features work with relational DB.",
      "acceptanceCriteria": [
        "Create `src/sources/database/schema/push-rules.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: id (PK), uid, name, pushTime, contentType, channels (JSON text), enabled, createdAt, updatedAt",
        "Create `src/sources/database/schema/daily-recommendations.ts` with MySQL/PostgreSQL/SQLite variants",
        "Schema fields: recommendationId (PK), uid, date, memoIds (JSON array), createdAt",
        "Add indexes for uid field in both tables (no foreign keys)",
        "Add unique index on (uid, date) for daily recommendations",
        "Export schemas and types from `src/sources/database/schema/index.ts`",
        "Update schema helper functions (getPushRulesTable, getDailyRecommendationsTable)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create repository layer for categories and tags",
      "description": "As a developer, I need repositories for categories and tags so services don't directly access Drizzle.",
      "acceptanceCriteria": [
        "Create `src/repositories/category.repository.ts` with methods: create(), findById(), findByUserId(), update(), delete(), findByIds()",
        "Create `src/repositories/tag.repository.ts` with methods: create(), findById(), findByUserId(), update(), delete(), findByIds(), incrementUsageCount(), decrementUsageCount()",
        "All methods return DTOs from `@aimo/dto`",
        "Repositories decorated with `@Service()` for TypeDI injection",
        "Export from `src/repositories/index.ts`",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create repository layer for AI conversations and messages",
      "description": "As a developer, I need repositories for AI conversations and messages so the chat service uses the repository pattern.",
      "acceptanceCriteria": [
        "Create `src/repositories/ai-conversation.repository.ts` with methods: create(), findById(), findByUserId(), update(), delete(), findWithMessages() (JOIN query)",
        "Create `src/repositories/ai-message.repository.ts` with methods: create(), findById(), findByConversationId(), delete(), batchCreate()",
        "Handle JSON serialization/deserialization for `sources` field in AIMessage",
        "Use JOIN queries (no foreign keys) for relational data",
        "All methods return DTOs from `@aimo/dto`",
        "Repositories decorated with `@Service()` for TypeDI injection",
        "Export from `src/repositories/index.ts`",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create repository layer for push rules and daily recommendations",
      "description": "As a developer, I need repositories for push rules and daily recommendations so notification services use the repository pattern.",
      "acceptanceCriteria": [
        "Create `src/repositories/push-rule.repository.ts` with methods: create(), findById(), findByUserId(), update(), delete(), findEnabledByTime()",
        "Create `src/repositories/daily-recommendation.repository.ts` with methods: create(), findByUserAndDate(), findByUserId(), delete(), upsert()",
        "Handle JSON serialization for `channels` (push rules) and `memoIds` (recommendations)",
        "All methods return DTOs from `@aimo/dto`",
        "Repositories decorated with `@Service()` for TypeDI injection",
        "Export from `src/repositories/index.ts`",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Generate and run Drizzle migrations",
      "description": "As a developer, I need database migrations for all new schemas so the database structure is created automatically.",
      "acceptanceCriteria": [
        "Run `pnpm db:generate` to create migration files for new schemas",
        "Verify migration files created in `src/sources/database/migrations/`",
        "Migrations include: categories, tags, ai_conversations, ai_messages, push_rules, daily_recommendations",
        "Test migrations on all three database types (MySQL, PostgreSQL, SQLite)",
        "Migrations run successfully via `DrizzleAdapter.runMigrations()` on startup",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Refactor CategoryService to use repository",
      "description": "As a developer, I need CategoryService to use CategoryRepository so all category data comes from Drizzle.",
      "acceptanceCriteria": [
        "Inject `CategoryRepository` into `CategoryService`",
        "Replace all LanceDB calls with repository methods",
        "`create()`, `update()`, `delete()`, `list()` use CategoryRepository",
        "Remove direct LanceDB imports and usage",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Refactor TagService to use repository",
      "description": "As a developer, I need TagService to use TagRepository so all tag data comes from Drizzle.",
      "acceptanceCriteria": [
        "Inject `TagRepository` into `TagService`",
        "Replace all LanceDB calls with repository methods",
        "`create()`, `update()`, `delete()`, `list()`, `incrementUsage()` use TagRepository",
        "Remove direct LanceDB imports and usage",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Refactor AIConversationService to use repositories",
      "description": "As a developer, I need AIConversationService to use repositories so AI chat data comes from Drizzle.",
      "acceptanceCriteria": [
        "Inject `AIConversationRepository` and `AIMessageRepository` into `AIConversationService`",
        "Replace all LanceDB calls with repository methods",
        "`createConversation()`, `getConversation()`, `listConversations()` use AIConversationRepository",
        "`addMessage()`, `getMessages()` use AIMessageRepository",
        "Use `findWithMessages()` for efficient conversation + messages retrieval (JOIN query)",
        "Handle JSON serialization/deserialization for message sources",
        "Remove direct LanceDB imports and usage",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Refactor PushRuleService to use repository",
      "description": "As a developer, I need PushRuleService to use PushRuleRepository so push notification rules come from Drizzle.",
      "acceptanceCriteria": [
        "Inject `PushRuleRepository` into `PushRuleService`",
        "Replace all LanceDB calls with repository methods",
        "`create()`, `update()`, `delete()`, `list()`, `findByTime()` use PushRuleRepository",
        "Handle JSON serialization for channels configuration",
        "Remove direct LanceDB imports and usage",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Refactor RecommendationService to use repository",
      "description": "As a developer, I need RecommendationService to use DailyRecommendationRepository so cached recommendations come from Drizzle.",
      "acceptanceCriteria": [
        "Inject `DailyRecommendationRepository` into `RecommendationService`",
        "Replace all LanceDB calls with repository methods",
        "`getDailyRecommendations()` checks Drizzle cache first, generates if missing",
        "`cacheDailyRecommendations()` uses `upsert()` to store recommendations",
        "Handle JSON serialization for memoIds array",
        "Remove direct LanceDB imports and usage",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Update EmbeddingService and MultimodalEmbeddingService",
      "description": "As a developer, I need embedding cache services to continue using LanceDB so cache performance remains optimal.",
      "acceptanceCriteria": [
        "Keep `EmbeddingService` using LanceDB for `embeddingCache` table (no changes needed)",
        "Keep `MultimodalEmbeddingService` using LanceDB for `multimodalEmbeddingCache` table (no changes needed)",
        "Verify both services work correctly with hybrid architecture (LanceDB for embeddings, Drizzle for metadata)",
        "Add comments documenting why cache tables remain in LanceDB (performance optimization)",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Update MemoService for tag and category relations",
      "description": "As a developer, I need MemoService to fetch tags and categories from Drizzle repositories so memo enrichment works correctly.",
      "acceptanceCriteria": [
        "Inject `TagRepository` and `CategoryRepository` into `MemoService`",
        "When fetching memos, use `TagRepository.findByIds()` to enrich tagIds with tag details",
        "When fetching memos, use `CategoryRepository.findById()` to enrich categoryId with category details",
        "Use batch fetch operations to avoid N+1 queries (fetch all tags/categories at once)",
        "Maintain existing memo DTO format (tags and category fields populated)",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Update ExploreService for category and tag queries",
      "description": "As a developer, I need ExploreService to query categories and tags from Drizzle so explore features work correctly.",
      "acceptanceCriteria": [
        "Inject `CategoryRepository` and `TagRepository` into `ExploreService`",
        "Replace LanceDB category/tag queries with repository methods",
        "`getCategories()`, `getTags()` use respective repositories",
        "Maintain existing service method signatures (DTOs unchanged)",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Update SchedulerService for push rule queries",
      "description": "As a developer, I need SchedulerService to fetch push rules from Drizzle so scheduled notifications work correctly.",
      "acceptanceCriteria": [
        "Inject `PushRuleRepository` into `SchedulerService`",
        "Replace LanceDB push rule queries with `PushRuleRepository.findEnabledByTime()`",
        "Scheduler correctly triggers notifications based on Drizzle data",
        "Maintain existing scheduler behavior (no functional changes)",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Update data migration script for new schemas",
      "description": "As a developer, I need the LanceDB-to-Drizzle migration script updated so historical data for new schemas is migrated.",
      "acceptanceCriteria": [
        "Update `src/migrations/lancedb-to-drizzle.migration.ts` to migrate: categories, tags, ai_conversations, ai_messages, push_rules, daily_recommendations",
        "Migration handles JSON serialization for complex fields (sources, channels, memoIds)",
        "Migration is transactional (rollback on failure)",
        "Backup includes all new tables",
        "Log migration progress for each table",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Update environment documentation",
      "description": "As a deployment engineer, I need updated documentation reflecting the completed migration so I know the system is fully hybrid.",
      "acceptanceCriteria": [
        "Update `CLAUDE.md` to list all migrated schemas",
        "Document that only embedding caches remain in LanceDB",
        "Update architecture diagram/description in `CLAUDE.md`",
        "Add note about JOIN queries and no foreign keys in Drizzle",
        "Document JSON field serialization for complex types",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    }
  ]
}
