# Ralph Progress: Drizzle Migration

Branch: ralph/drizzle-migration

## Status
- US-003: COMPLETED

## Notes

## 2026-03-01 - US-003
- Configured drizzle-kit in apps/server/drizzle.config.ts
- Added db scripts to package.json: db:generate, db:push, db:migrate, db:studio
- Generated initial migration SQL in src/sources/database/migrations/
- Implemented DrizzleAdapter.runMigrations() method:
  - Reads SQL migration files from migrations directory
  - Queries _migrations table for executed migrations (by hash)
  - Executes pending migrations with database-type-specific syntax
  - Records each migration in _migrations table with hash and timestamp
- Integrated migration execution into app.ts startup sequence (after Drizzle init)
- Added graceful shutdown cleanup for Drizzle connections
- Typecheck passes, lint passes (warnings present but no errors)
- **Learnings:**
  - drizzle-kit must use .cjs extension with tsx (tsx node_modules/drizzle-kit/bin.cjs)
  - Use process.env directly in drizzle.config.ts instead of importing config
  - Migration hashes computed from file content for change detection
  - MySQL/PostgreSQL: use .execute(), SQLite: use .run() for raw SQL execution

---

## Codebase Patterns
- Drizzle ORM integration uses drivers: drizzle-orm/mysql2, drizzle-orm/node-postgres, drizzle-orm/better-sqlite3
- Database type selected via DATABASE_TYPE env var (mysql|postgresql|sqlite, default: mysql)
- Config interfaces for each database type defined in apps/server/src/config/config.ts
- DrizzleAdapter is decorated with @Service() for TypeDI injection
- Connection pooling configured for each DB type: mysql2 pools, pg pools, better-sqlite3 direct
---

## 2026-03-01 - US-002
- Created schema files in apps/server/src/sources/database/schema/
- users.ts: User account information (MySQL, PostgreSQL, SQLite)
- memos.ts: Memo scalar data excluding embeddings (stored in LanceDB)
- memo-relations.ts: Directed relations between memos
- attachments.ts: File attachment metadata
- _migrations.ts: Migration tracking table
- Each schema includes appropriate column types:
  - MySQL: mysqlTable with serial, varchar, text, timestamp, int, json
  - PostgreSQL: pgTable with serial, varchar, text, timestamp, integer, json
  - SQLite: sqliteTable with integer primary keys and text for strings
- Indexes defined for frequently queried fields (userId, createdAt, tags)
- Typecheck passes
- **Learnings:**
  - Timestamp mode: use 'date' for MySQL/PostgreSQL, 'timestamp' is invalid
  - SQLite stores timestamps as integers (Unix timestamps)
  - PostgreSQL serial is imported as pgSerial from drizzle-orm/pg-core
  - MySQL uses 'int' not 'integer' for integer columns
---

## 2026-03-01 - US-001
- Created DrizzleAdapter class in apps/server/src/sources/database/drizzle-adapter.ts
- Implemented connection factory for MySQL, PostgreSQL, and SQLite
- Database type selected via config.database.type from DATABASE_TYPE env var
- Connection configs: MySQL uses mysql2/promise pools, PostgreSQL uses pg pools, SQLite uses better-sqlite3
- Graceful connection error handling with logger.error for failures
- Exported DatabaseClient and DatabaseType types from index.ts
- Typecheck passes
- **Learnings for future iterations:**
  - Drizzle drivers: use drizzle-orm/mysql2 (not mysql-core), drizzle-orm/node-postgres, drizzle-orm/better-sqlite3
  - Store pool/connection references separately (mysqlPool, pgPool, sqliteDb) instead of accessing via Drizzle types
  - DrizzleAdapter decorated with @Service() for TypeDI
  - Config interfaces: DatabaseType, MySQLConfig, PostgreSQLConfig, SQLiteConfig in config.ts
---
