# Ralph Progress: Drizzle Migration

Branch: ralph/drizzle-migration

## Status
- US-009: COMPLETED
- US-008: COMPLETED
- US-007: COMPLETED
- US-006: COMPLETED
- US-005: COMPLETED
- US-004: COMPLETED
- US-003: COMPLETED

## Notes

## 2026-03-01 - US-009
- Created migration script `src/migrations/lancedb-to-drizzle.migration.ts`
- Checks if LanceDB has data and Drizzle is empty before migration
- Exports LanceDB backup to `./backups/lancedb-backup-[timestamp].json` before migration
- Migrates tables: users, memos, memo_relations, attachments
- Processes data in batches of 100 records with progress logging
- Records migration completion in `_migrations` table with hash to prevent re-run
- Integrated into app.ts after Drizzle migrations run
- Typecheck passes, lint passes (warnings only)
- **Learnings:**
  - LanceDB table data queried via `db.openTable().query().toArray()`
  - Migration uses MIGRATION_HASH constant for tracking in _migrations table
  - Batch processing with logging shows progress (e.g., 'Migrated 1/100...')
  - SQLite requires direct .prepare().run() instead of Drizzle query builder
  - Timestamp conversion: LanceDB uses milliseconds, Drizzle uses Date objects or Unix timestamps for SQLite
  - Attachments use createdAt for updatedAt since LanceDB schema doesn't have updatedAt

---

## 2026-03-01 - US-008
- Refactored UserService to use UserRepository instead of LanceDB
- Refactored AttachmentService to use AttachmentRepository instead of LanceDB
- Added findByEmailWithPassword(), findByUidWithPassword(), updatePassword() methods to UserRepository for authentication
- Added AttachmentFullRecord interface and findByIdFull() method to AttachmentRepository for URL generation
- UserService: createUser(), findUserByEmail(), findUserByUid(), updateUser(), deleteUser(), changePassword() all use repository
- AttachmentService: createAttachment(), getAttachment(), getAttachmentsByUser(), updateAttachmentProperties(), deleteAttachment(), getAttachmentsByIds(), getAttachmentBuffer() all use repository
- File upload/storage logic unchanged (only metadata storage migrated to Drizzle)
- JWT authentication flow unchanged
- Typecheck passes, lint passes (warnings present but no errors)
- **Learnings:**
  - Password/salt needed for authentication - add findByEmailWithPassword() and findByUidWithPassword() methods to repository
  - URL generation requires storage metadata (storageType, bucket, endpoint, etc.) - use findByIdFull() for full record
  - Service methods maintain same signatures - repository returns DTOs which are compatible
  - LanceDB removed from service constructors - file storage still uses storage adapters

---

## 2026-03-01 - US-006
- Refactored MemoService to use hybrid storage (Drizzle + LanceDB)
- createMemo() writes to both Drizzle (scalar) and LanceDB (vector + id)
- updateMemo() updates both Drizzle and LanceDB
- deleteMemo() removes from both stores
- getMemoById() fetches from Drizzle only
- getMemos() fetches from Drizzle with pagination/filters
- Vector search flow: LanceDB returns IDs â†’ MemoRepository.findByIds() fetches details
- Typecheck passes, lint passes (warnings present but no errors)
- **Learnings:**
  - Use explicit object construction instead of spread for DTO return types to avoid type conflicts
  - Convert null to undefined for optional parameters (repository expects string | undefined)
  - UpdateMemoDto requires content field - pass empty string for partial updates

## 2026-03-01 - US-005
- Added DATABASE_URL env var support to config.ts with parseMySQLUrl() and parsePostgreSQLUrl() functions
- Added environment validation on startup with validateRequiredEnvVars() function
- Validates: JWT_SECRET, OPENAI_API_KEY, and database connection parameters
- Throws descriptive error messages for missing required vars
- Updated .env.example files (root and apps/server) with DATABASE_URL, DATABASE_TYPE, DATABASE_POOL_SIZE
- Updated CLAUDE.md with:
  - Hybrid storage architecture description (Drizzle + LanceDB)
  - Database configuration section with connection string examples
  - Updated Key Technologies to list Drizzle ORM
  - Added Repository Layer Pattern section
  - Added Database CLI Commands section
  - Updated Storage Adapters to include database/ directory
- Typecheck passes, lint passes (warnings only)
- **Learnings:**
  - DATABASE_URL parsing requires separate type-safe functions for each DB type
  - Connection string format: mysql://user:pass@host:port/db or postgresql://user:pass@host:port/db
  - Validate env vars at config load time before other initialization
---

## 2026-03-01 - US-004
- Created repository layer in apps/server/src/repositories/
- MemoRepository: create(), findById(), findByUserId(), findByIds(), update(), delete(), search()
- UserRepository: create(), findByEmail(), findByUid(), update(), delete()
- AttachmentRepository: create(), findById(), findByIdAndUid(), findByUserId(), findByIds(), updateProperties(), delete()
- MemoRelationRepository: create(), findBySourceMemoId(), findByTargetMemoId(), delete(), deleteBySourceMemoId(), deleteByTargetMemoId(), replaceRelations()
- Added isPublic field to memos schema for MySQL, PostgreSQL, and SQLite
- All repositories use @Service() decorator for TypeDI
- All methods return DTOs from @aimo/dto package
- Typecheck passes
- **Learnings:**
  - Drizzle union types require `as any` casting for database client operations
  - isPublic stored as integer (0/1) in DB, converted to boolean in DTOs
  - UseMemoSearchOptions interface includes tags, startDate, endDate for filtering
---

## 2026-03-01 - US-003
- Configured drizzle-kit in apps/server/drizzle.config.ts
- Added db scripts to package.json: db:generate, db:push, db:migrate, db:studio
- Generated initial migration SQL in src/sources/database/migrations/
- Implemented DrizzleAdapter.runMigrations() method:
  - Reads SQL migration files from migrations directory
  - Queries _migrations table for executed migrations (by hash)
  - Executes pending migrations with database-type-specific syntax
  - Records each migration in _migrations table with hash and timestamp
- Integrated migration execution into app.ts startup sequence (after Drizzle init)
- Added graceful shutdown cleanup for Drizzle connections
- Typecheck passes, lint passes (warnings present but no errors)
- **Learnings:**
  - drizzle-kit must use .cjs extension with tsx (tsx node_modules/drizzle-kit/bin.cjs)
  - Use process.env directly in drizzle.config.ts instead of importing config
  - Migration hashes computed from file content for change detection
  - MySQL/PostgreSQL: use .execute(), SQLite: use .run() for raw SQL execution

---

## Codebase Patterns
- Drizzle ORM integration uses drivers: drizzle-orm/mysql2, drizzle-orm/node-postgres, drizzle-orm/better-sqlite3
- Database type selected via DATABASE_TYPE env var (mysql|postgresql|sqlite, default: mysql)
- Config interfaces for each database type defined in apps/server/src/config/config.ts
- DrizzleAdapter is decorated with @Service() for TypeDI injection
- Connection pooling configured for each DB type: mysql2 pools, pg pools, better-sqlite3 direct
---

## 2026-03-01 - US-002
- Created schema files in apps/server/src/sources/database/schema/
- users.ts: User account information (MySQL, PostgreSQL, SQLite)
- memos.ts: Memo scalar data excluding embeddings (stored in LanceDB)
- memo-relations.ts: Directed relations between memos
- attachments.ts: File attachment metadata
- _migrations.ts: Migration tracking table
- Each schema includes appropriate column types:
  - MySQL: mysqlTable with serial, varchar, text, timestamp, int, json
  - PostgreSQL: pgTable with serial, varchar, text, timestamp, integer, json
  - SQLite: sqliteTable with integer primary keys and text for strings
- Indexes defined for frequently queried fields (userId, createdAt, tags)
- Typecheck passes
- **Learnings:**
  - Timestamp mode: use 'date' for MySQL/PostgreSQL, 'timestamp' is invalid
  - SQLite stores timestamps as integers (Unix timestamps)
  - PostgreSQL serial is imported as pgSerial from drizzle-orm/pg-core
  - MySQL uses 'int' not 'integer' for integer columns
---

## 2026-03-01 - US-001
- Created DrizzleAdapter class in apps/server/src/sources/database/drizzle-adapter.ts
- Implemented connection factory for MySQL, PostgreSQL, and SQLite
- Database type selected via config.database.type from DATABASE_TYPE env var
- Connection configs: MySQL uses mysql2/promise pools, PostgreSQL uses pg pools, SQLite uses better-sqlite3
- Graceful connection error handling with logger.error for failures
- Exported DatabaseClient and DatabaseType types from index.ts
- Typecheck passes
- **Learnings for future iterations:**
  - Drizzle drivers: use drizzle-orm/mysql2 (not mysql-core), drizzle-orm/node-postgres, drizzle-orm/better-sqlite3
  - Store pool/connection references separately (mysqlPool, pgPool, sqliteDb) instead of accessing via Drizzle types
  - DrizzleAdapter decorated with @Service() for TypeDI
  - Config interfaces: DatabaseType, MySQLConfig, PostgreSQLConfig, SQLiteConfig in config.ts
---

## 2026-03-01 - US-007
- Verified hybrid search implementation already exists in MemoService.vectorSearch()
- LanceDB performs vector similarity search and returns IDs
- MemoRepository.findByIds() fetches scalar details from Drizzle
- Supports combined queries with categoryId, startDate, endDate filters
- Returns MemoListItemWithScoreDto with relevance scores
- Typecheck passes, lint passes (warnings only)
- **Learnings:**
  - SearchService functionality integrated into MemoService (not a separate service)
  - Vector search handles pre-filtering (uid, categoryId) in LanceDB
  - Date range filters applied in JavaScript after LanceDB query (LanceDB timestamp comparison limitations)
  - Relevance score normalized from L2 distance (1 - distance/2, clamped 0-1)
---
