# Ralph Progress: Timed Notification Feature

Branch: ralph/timed-notification

## Status

## Notes

## Codebase Patterns
- Use Apache Arrow Schema and Field types for LanceDB table schemas
- Create migration scripts in `apps/server/src/migrations/scripts/` with version numbers (e.g., 015-add-push-rules.ts)
- Register migrations in `apps/server/src/migrations/scripts/index.ts` in the ALL_MIGRATIONS array

---

## 2026-02-25 - US-001
- Implemented: Created push_rules database table with schema fields: id, uid, name, pushTime, contentType, channels (JSON string), enabled, createdAt, updatedAt
- Files changed:
  - apps/server/src/models/db/schema.ts - Added pushRulesSchema and PushRuleRecord interface
  - apps/server/src/models/db/index.ts - Added export for schema.ts
  - apps/server/src/migrations/scripts/015-add-push-rules.ts - New migration script
  - apps/server/src/migrations/scripts/index.ts - Registered the new migration

- **Learnings for future iterations:**
  - LanceDB uses Apache Arrow types for schema definition
  - JSON fields are stored as string in LanceDB (use JSON.stringify/parse)
  - Migration version numbers continue from existing migrations (last was 014, this is 015)
  - Migration scripts follow the pattern: createTableIfNotExists helper, then export Migration object with version, tableName, description, and up function

---

## 2026-02-25 - US-002
- Implemented: Created push rules DTO and service layer
- Files changed:
  - packages/dto/src/push-rule.ts - New DTO file with PushRuleDto, CreatePushRuleDto, UpdatePushRuleDto, PushChannelConfigDto
  - packages/dto/src/index.ts - Added export for push-rule DTOs
  - apps/server/src/models/constant/type.ts - Added PUSH_RULE to OBJECT_TYPE
  - apps/server/src/services/push-rule.service.ts - New service with CRUD methods

- **Learnings for future iterations:**
  - DTOs are defined in packages/dto/src/ and exported from index.ts
  - Services use TypeDI @Service() decorator
  - Use LanceDbService to open tables and perform CRUD operations
  - Use generateTypeId with OBJECT_TYPE to generate unique IDs
  - Channel configurations stored as JSON string in the database, parsed when reading

---

## 2026-02-25 - US-003
- Implemented: Created push rules REST API controller
- Files changed:
  - apps/server/src/controllers/v1/push-rule.controller.ts - New controller with CRUD endpoints
  - apps/server/src/controllers/index.ts - Registered the controller

- **Learnings for future iterations:**
  - Controllers are in apps/server/src/controllers/v1/ directory
  - Use routing-controllers decorators: @JsonController, @Get, @Post, @Put, @Delete, @Body, @Param, @CurrentUser
  - Register controllers in apps/server/src/controllers/index.ts
  - Use ResponseUtil for consistent API responses
  - Use ErrorCode for error handling
  - Validation is done manually in controller/service layer

---

## 2026-02-25 - US-004
- Implemented: Created PushChannel interface and MeoW adapter
- Files changed:
  - apps/server/src/services/channels/push-channel.interface.ts - New interface with send(options) method
  - apps/server/src/services/channels/meow.channel.ts - New MeoWChannel class implementing PushChannel

- **Learnings for future iterations:**
  - Create services/channels/ directory for channel adapters
  - PushChannel interface defines send(options) with title, msg, and optional url
  - MeoWChannel sends POST requests to api.chuckfang.com with form data
  - Use @Service() decorator for TypeDI to enable dependency injection if needed

---

## 2026-02-25 - US-005
- Implemented: Created ChannelFactory for adapter pattern
- Files changed:
  - apps/server/src/services/channels/channel.factory.ts - New factory class with getChannel method

- **Learnings for future iterations:**
  - Factory pattern uses switch statement to return appropriate channel instance
  - ChannelFactory is decorated with @Service() for TypeDI
  - ChannelConfig interface defines type, nickname, msgType, htmlHeight
  - Throw error for unsupported channel types
