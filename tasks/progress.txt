# Ralph Progress: Chrome Extension

Branch: ralph/chrome-extension-v1

## Status

## Notes

## Codebase Patterns
- Migrations are in apps/server/src/migrations/scripts/ and follow a numbered version pattern (e.g., 016-add-memo-source.ts)
- Each migration exports a Migration object with version, tableName, description, and up() function
- Register new migrations in apps/server/src/migrations/scripts/index.ts by importing and adding to ALL_MIGRATIONS array
- Use LanceDB's addColumns() to add new columns, with valueSql: 'CAST(NULL AS STRING)' to explicitly set Utf8 type
- Handle "already exists" errors gracefully by catching and returning early
---

## 2026-02-27 - US-001
- Added source?: string field to CreateMemoDto, MemoDto, MemoWithAttachmentsDto, and MemoListItemDto in packages/dto/src/memo.ts
- Rebuilt DTO package
- Typecheck passes
- **Learnings for future iterations:**
  - Memo DTOs are in packages/dto/src/memo.ts - all related interfaces (CreateMemoDto, MemoDto, MemoWithAttachmentsDto, MemoListItemDto) need to be updated together
  - After modifying DTOs, run `pnpm --filter @aimo/dto build` to regenerate types
  - Server typecheck requires logger package to be built first: `pnpm --filter @aimo/logger build`
---

## 2026-02-27 - US-002
- Added source field to memosSchema in apps/server/src/models/db/schema.ts using Arrow types (new Field('source', new Utf8(), true))
- Added source?: string to MemoRecord interface
- Typecheck passes
- **Learnings for future iterations:**
  - LanceDB schema is defined in apps/server/src/models/db/schema.ts
  - Schema uses Apache Arrow types (Schema, Field, Utf8, etc.)
  - Optional fields use nullable: true in the Field constructor
  - TypeScript interfaces mirror the schema fields for type safety
---

## 2026-02-27 - US-003
- Created migration script 016-add-memo-source.ts to add source column to memos table
- Migration uses LanceDB's addColumns() with valueSql: 'CAST(NULL AS STRING)' to add nullable source column
- Registered migration in index.ts (ALL_MIGRATIONS array)
- Typecheck passes
- **Learnings for future iterations:**
  - Migration version numbers continue from existing migrations (latest was 015)
  - Use try/catch to handle "already exists" errors gracefully
  - Migration will run automatically on server startup via the migration executor
---

## 2026-02-27 - US-004
- Updated memo.service.ts createMemo() to accept source parameter and include it in memo object
- Added source?: string to Memo interface in apps/server/src/models/db/memo.schema.ts
- Updated memo.controller.ts to pass memoData.source to service
- Typecheck passes
- **Learnings for future iterations:**
  - Memo interface in memo.schema.ts is separate from MemoRecord in schema.ts - need to update both
  - Controller passes DTO data directly to service createMemo method
---

## 2026-02-27 - US-005
- Added source URL badge to MemoCard component in apps/web/src/pages/home/components/memo-card.tsx
- Badge shows Link icon with "来源" text when memo.source exists
- Clicking opens source URL in new tab
- Uses green color scheme for visibility in both light and dark themes
- Build passes
- **Learnings for future iterations:**
  - MemoListItemDto already has source field from US-001
  - Badges are added in the footer section near category and isPublic badges
  - Use a tags for external links to ensure proper accessibility
---

## 2026-02-27 - US-006
- Verified existing extension build in apps/extension
- Ran `pnpm build` - builds successfully
- Verified manifest.json is in dist/
- Verified popup (dist/popup.js, dist/src/popup/index.html), background (dist/background/index.js), content scripts (dist/content/index.js) are built
- Typecheck passes
- **Learnings for future iterations:**
  - Extension is in apps/extension with Vite build system
  - Build output is in dist/ folder
---

## 2026-02-27 - US-007
- Added token input option to ConfigPage login form in apps/extension/src/popup/ConfigPage.tsx
- Added tab toggle between password login and token login methods
- Updated form validation to handle both login methods
- Updated handleSubmit to support both password login (calls /api/v1/auth/login) and token login (uses token directly)
- Token is saved to chrome.storage on success
- Error messages shown on failure
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Extension popup UI uses inline styles (React.CSSProperties)
  - Login uses setConfig() from storage/index.js to save credentials
  - Both login methods ultimately save to chrome.storage with url, token, and username
  - Config type has username as optional
---

## 2026-02-27 - US-008
- Verified existing text selection floating button implementation in apps/extension/src/content/index.ts
- Content script listens to selectionchange event (more robust than mouseup)
- When text is selected, floating button appears near selection
- Button shows '保存到 AIMO' text (Save to AIMO in Chinese)
- Uses shadow DOM for proper styling and visibility on any background
- Button is hidden when no text is selected or on scroll
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Content script uses shadow DOM for style isolation
  - Uses selectionchange event instead of mouseup for better detection
  - Captures sourceUrl and sourceTitle when text is selected
  - Handles both text and image content types
---

## 2026-02-27 - US-009
- Added image hover support to content script in apps/extension/src/content/index.ts
- Added mouseover/mouseout event listeners for image hover detection
- Shows toolbar after 300ms delay on hover to avoid flashing
- Hides toolbar when mouse leaves image
- Button shows '保存图片到 AIMO' text for images
- Still supports click-based image saving as fallback
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Used setTimeout with 300ms delay to avoid showing button on brief mouseover
  - Image hover and click handlers share showImageToolbar() function
  - hasVisibleImage() checks for both <img> tags and background-image styles
---

## 2026-02-27 - US-010
- Added background script API handler in apps/extension/src/background/index.ts
- Added SAVE_TO_MEMO handler for creating memos via API (both text and image)
- Added CHECK_AUTH handler for checking login status
- Uses getCurrentConfig from api/aimo (not getConfig which is internal)
- ApiError imported from types/index.ts
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Background script runs in service worker context (not DOM)
  - Message handlers use return true to keep channel open for async responses
  - api/aimo exports isLoggedIn, createMemo, downloadAndUploadImage, getCurrentConfig
  - Error handling wraps ApiError and generic errors consistently
---

## 2026-02-27 - US-011
- Updated content script handleSaveClick to use SAVE_TO_MEMO instead of SAVE_CONTENT
- Content script now directly creates memo via API instead of saving to local storage
- Shows success notification with '已保存到 AIMO' message
- Shows error notification on failure
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - SAVE_CONTENT saves to pending items in chrome.storage for later sync
  - SAVE_TO_MEMO creates memo directly via API
  - Both message types are handled by background script
---

## 2026-02-27 - US-012
- Added showLoadingNotification function with spinner animation
- Shows "正在上传图片..." loading state while uploading images
- Loading notification is removed when upload completes or fails
- Success/error notifications shown after loading completes
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - chrome.runtime.sendMessage is request/response - no easy progress updates
  - Show loading state while waiting for response
  - Loading notification returns element so caller can remove it
---

## 2026-02-27 - US-013
- Verified existing category API in apps/server/src/controllers/v1/category.controller.ts
- GET /api/v1/categories returns user's categories with id and name
- Uses @CurrentUser() for authentication - users only see their own categories
- Full CRUD API exists (GET, POST, PUT, DELETE)
- Typecheck passes
- **Learnings for future iterations:**
  - Category controller uses CategoryService for business logic
  - Response format uses ResponseUtility.success/error helpers
  - Uses routing-controllers decorators (@Get, @Post, @Put, @Delete)
---

## 2026-02-27 - US-014
- Added getCategories() function to apps/extension/src/api/aimo.ts
- Added Settings interface to apps/extension/src/types/index.ts
- Added getSettings() and setSettings() functions to apps/extension/src/storage/index.ts
- Updated ConfigPage to have Account and Settings tabs
- Settings tab fetches categories from API and shows dropdown
- User can select default category or clear selection
- Setting saved to chrome.storage.local
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Settings stored separately from Config using SETTINGS_KEY ('aimo_settings')
  - Categories fetched from GET /api/v1/categories endpoint
  - useEffect loads categories when Settings tab is activated
  - handleCategoryChange saves to storage immediately on change
---

## 2026-02-27 - US-015
- Added saveSourceUrl toggle to Settings tab in ConfigPage
- Toggle defaults to enabled (true)
- Setting saved to chrome.storage.local using setSettings()
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Toggle uses custom button with sliding circle animation
  - State defaults to true using nullish coalescing: settings.saveSourceUrl ?? true
---

## 2026-02-27 - US-016
- Added source field to CreateMemoRequest in types/index.ts
- Updated createMemo in api/aimo.ts to accept source parameter
- Updated background script to get settings and check saveSourceUrl toggle
- Passes source to createMemo when saveSourceUrl is enabled (defaults to true)
- Typecheck passes
- Build passes
- **Learnings for future iterations:**
  - Content script already captures sourceUrl in ExtractedContent
  - Background script imports getSettings from storage module
  - Uses nullish coalescing to default to true: settings.saveSourceUrl ?? true
  - createMemo now accepts optional 4th parameter for source
---
