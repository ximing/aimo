## Codebase Patterns
- Use `routing-controllers` decorators (@Get, @Post, etc.) for API endpoints
- All services use TypeDI `@Service()` decorator for dependency injection
- Controllers return `ResponseUtil.success()` or `ResponseUtil.error()` for consistent responses
- LanceDB queries use `.where()` with SQL-like syntax for filtering
- User isolation: Every database operation must filter by `uid` for security
- Relations are stored in a separate `memo_relations` table with source/target memo IDs
- DTO types are defined in `packages/dto/src/` and shared between frontend/backend
- When adding controller endpoints, inject new services via constructor (TypeDI handles this automatically)

---

## 2026-02-17T17:30:00Z - US-001
- Implemented GET /api/v1/memos/:id/backlinks API endpoint
- Added `getBacklinks()` method to MemoRelationService to query reverse relations
- Added `getMemosByIds()` method to MemoService for batch memo fetching
- Files changed:
  - apps/server/src/controllers/v1/memo.controller.ts
  - apps/server/src/services/memo-relation.service.ts
  - apps/server/src/services/memo.service.ts
  - CLAUDE.md
- **Learnings for future iterations:**
  - The memo relations are stored in a separate `memo_relations` table with source/target fields
  - `MemoRelationService` handles all relation operations - forward relations use `getRelatedMemos()`, backlinks use `getBacklinks()`
  - Controllers use TypeDI constructor injection - just add the service to the constructor and it works
  - Pagination is done manually (slice arrays) since LanceDB doesn't have built-in pagination for this use case
  - The project has no existing test infrastructure for memo endpoints - tests would need to be set up from scratch

## 2026-02-17T18:15:00Z - US-002
- 重构相关笔记弹窗为三栏标签页布局
- 新增 backlinks API 接口调用 (getBacklinks)
- 新增 MemoService.getBacklinks() 方法
- 重构 RelatedMemosModal 为标签页布局，包含四个选项卡：
  - 语义相关：保持现有相似度搜索功能
  - 关联了：展示主动关联的笔记 (memo.relations)
  - 被关联：调用新增的 backlinks 接口
  - 关联图谱：占位符，待 US-003 实现
- 每个列表项显示内容摘要、创建时间
- 点击笔记卡片可跳转到对应笔记详情 (带高亮效果)
- 空状态显示友好提示
- 添加 memo-card ID 属性用于滚动定位
- Files changed:
  - apps/web/src/api/memo.ts
  - apps/web/src/services/memo.service.ts
  - apps/web/src/pages/home/components/related-memos-modal.tsx
  - apps/web/src/pages/home/components/memo-card.tsx
- **Learnings for future iterations:**
  - HeadlessUI Tab component is already available in the project
  - Use useCallback for load functions to avoid react-hooks/exhaustive-deps warnings
  - The memo.relations array contains forward relations (notes this memo links to)
  - For scroll-to-memo functionality, add id={`memo-${memo.memoId}`} to the card element
  - Tab counts update reactively as data loads

## 2026-02-17T19:30:00Z - US-003
- 新增关联图谱视图，使用 D3.js 力导向图实现
- 创建 RelationGraph 组件，支持以下功能：
  - 力导向图布局 (force-directed graph)
  - 中心节点高亮显示当前笔记（橙色）
  - 主动关联笔记用蓝色实线箭头表示
  - 被关联笔记用绿色虚线箭头表示
  - 支持节点拖拽、画布缩放（滚轮）、点击查看详情
  - 节点显示笔记内容前30字
  - 限制节点总数不超过50个（平均分配给正向/反向关联）
  - 添加图例和操作提示
- 集成到 RelatedMemosModal 的关联图谱标签页
- Files changed:
  - apps/web/package.json (added d3 and @types/d3)
  - apps/web/src/pages/home/components/relation-graph.tsx (new)
  - apps/web/src/pages/home/components/related-memos-modal.tsx
- **Learnings for future iterations:**
  - D3.js v7 with TypeScript requires careful type handling for drag behavior
  - Use `d3.drag<SVGGElement, GraphNode>()` with explicit event types
  - Force simulation needs cleanup in useEffect return function to prevent memory leaks
  - SVG markers for arrowheads need proper `refX` to not overlap with nodes
  - Use `selectAll<SVGGElement, GraphNode>()` for proper TypeScript type inference
  - Dark mode support: use Tailwind dark: prefixes for legend/tooltip styling

## 2026-02-18T04:45:00Z - US-001
- 创建日历热力图组件 (CalendarHeatmap)
- 实现 GitHub 风格的方块网格热力图（7行x13周）
- 支持4个颜色等级：无数据(bg-gray-100)、低(bg-primary-200)、中(bg-primary-400)、高(bg-primary-600/800)
- 顶部显示月份标签（中文简写）
- 鼠标悬停显示具体日期和memo数量的tooltip
- 组件接受 data: Array<{date: string, count: number}> 作为输入
- 点击日期触发 onDateSelect 回调
- 底部显示图例（少 -> 多）
- Files changed:
  - apps/web/src/components/calendar-heatmap.tsx (new)
- **Learnings for future iterations:**
  - 热力图使用固定尺寸的小方块 (w-3 h-3) 配合 gap-[2px] 实现紧凑布局
  - 使用 useMemo 缓存 dataMap 和 gridData 避免重复计算
  - Tooltip 使用 fixed 定位并计算元素位置，避免被父容器裁剪
  - 颜色等级使用 Tailwind 的 primary 色阶，自动支持 dark mode
  - 星期标签只显示一、三、五，节省空间
  - 月份标签使用绝对定位，根据 weekIndex 计算水平位置

## 2026-02-18T05:30:00Z - US-002
- 添加 DTO 类型：MemoActivityStatsDto 和 MemoActivityStatsItemDto
- 创建 GET /api/v1/memos/stats/activity API 端点
- 添加 getActivityStats 方法到 MemoService
  - 返回最近90天（可配置）的每日memo数量统计
  - 按用户ID过滤，确保数据隔离
  - 使用 createdAt 时间戳分组统计
- 添加前端 getActivityStats API 调用方法
- Files changed:
  - packages/dto/src/memo.ts
  - apps/server/src/controllers/v1/memo.controller.ts
  - apps/server/src/services/memo.service.ts
  - apps/web/src/api/memo.ts
- **Learnings for future iterations:**
  - LanceDB 查询使用 SQL-like 语法进行日期范围过滤：`createdAt >= ${timestamp}`
  - 日期分组使用 `toISOString().split('T')[0]` 获取 YYYY-MM-DD 格式
  - API 返回格式包含 items 数组和 startDate/endDate 范围信息
  - 参数验证：使用 Math.min/Math.max 限制 days 参数在 1-365 之间

## 2026-02-18T06:00:00Z - US-003 (热力图布局)
- 在memo列表左侧新增可收起的热力图列（默认展开，宽度220px）
- 集成CalendarHeatmap组件显示活跃度数据
- 添加收起/展开按钮，固定在侧边栏右侧
  - 展开时按钮内嵌在列边缘
  - 收起时按钮悬浮在左侧导航栏右侧
- 添加localStorage支持保存收起状态（aimo:heatmap:collapsed）
- 预留下方区域为后续功能准备
- 从API获取90天活跃度统计数据
- 添加加载状态显示（旋转动画）
- Files changed:
  - apps/web/src/pages/home/home.tsx
- **Learnings for future iterations:**
  - 使用`w-0 opacity-0`和固定宽度`w-[220px]`实现平滑的展开/收起动画
  - 按钮使用`-ml-3`负边距在展开时与列边缘重叠
  - 收起时使用`fixed left-[70px]`定位在左侧导航栏右侧
  - localStorage读写需要try-catch防止隐私模式错误
  - 使用`transition-all duration-300 ease-in-out`实现平滑过渡效果
  - US-005（记住收起状态）已在此迭代中一并实现

## 2026-02-18T07:30:00Z - US-004
- 实现点击热力图日期筛选memo功能
- 添加 selectedDate 状态到 MemoService，支持按日期筛选
- 点击日期时设置 startDate/endDate 为当天开始/结束时间
- URL参数自动更新为 ?date=YYYY-MM-DD，支持分享和刷新保持状态
- 再次点击同一日期取消筛选（toggle行为）
- 在顶部搜索栏左侧显示日期筛选状态标签，带日历图标和清除按钮
- 热力图中选中的日期显示高亮边框（ring-2 ring-primary-500）
- Files changed:
  - apps/web/src/services/memo.service.ts
  - apps/web/src/pages/home/home.tsx
  - apps/web/src/components/calendar-heatmap.tsx
- **Learnings for future iterations:**
  - 使用 window.history.replaceState 更新 URL 不会触发页面刷新，适合筛选状态
  - 日期格式验证使用正则 /^\d{4}-\d{2}-\d{2}$/ 确保格式正确
  - 当天的开始/结束时间通过 setHours(0,0,0,0) 和 setHours(23,59,59,999) 设置
  - 热力图组件通过 aria-pressed 属性标识选中状态，提升可访问性

## 2026-02-18T10:00:00Z - BUG-001 (时间戳转换修复 - 三阶段)
- 修复热力图日期筛选时间戳转换错误
  - 第一阶段问题：MemoList中2月17日有数据，但热力图没显示，点击后接口返回空数据
    - 根本原因：前端使用本地时区创建日期，后端当作UTC处理，导致时间范围错位
  - 第二阶段问题：修复后发现LanceDB Timestamp类型无法与SQL中的整数字面值进行比较
    - 错误信息：`Invalid user input: Received literal Int64(...) and could not convert to literal of type 'Timestamp(Millisecond, None)'`
  - 第三阶段问题：getActivityStats() 修复后，getMemos() 接口仍报错 "No field named NaN"
    - 根本原因：控制器接收字符串类型的时间戳，直接用 new Date(string) 构造导致 NaN
    - 前端发送 `1771372800000`，通过查询参数成为字符串 `"1771372800000"`
    - `new Date("1771372800000")` 尝试解析为ISO日期字符串，结果为 NaN
- 修复方案：
  - 前端 setSelectedDate() 改用 Date.UTC() 创建UTC时间，而不是本地时间
  - 后端 getActivityStats() 两处修复：
    1. 改用 getUTCFullYear/Month/Date 等方法格式化日期
    2. **重要**: LanceDB无法在SQL WHERE条件中将整数与Timestamp类型进行比较，改为先查询所有用户数据，再在JavaScript中进行日期范围过滤
  - 后端 MemoV1Controller.getMemos() 修复：
    1. 将字符串时间戳用 parseInt() 转换为数字
    2. 检查 isNaN() 避免无效时间戳
    3. 只有有效时间戳才构造 Date 对象
  - 后端 MemoService.getMemos() 根本修复：
    1. **重要**: 不再在 SQL WHERE 条件中使用日期范围过滤
    2. 改为先查询所有符合 uid/categoryId/search 的记录
    3. 在 JavaScript 中进行日期范围过滤
    4. 这样完全避免了 LanceDB Timestamp 类型转换问题
- Files changed:
  - apps/web/src/services/memo.service.ts (setSelectedDate方法)
  - apps/server/src/services/memo.service.ts (getActivityStats和getMemos方法)
  - apps/server/src/controllers/v1/memo.controller.ts (getMemos端点)
- **Learnings for future iterations:**
  - JavaScript Date 时间戳计算中必须统一时区处理
  - 前端发送日期时应转换为UTC，避免跨时区不一致
  - 后端格式化日期时应使用 getUTC* 方法而非 get* 方法
  - 查询参数中的数字会被转换为字符串，需要显式 parseInt() 转换
  - new Date(string) 假定字符串是ISO格式，对于时间戳字符串需要先 parseInt()
  - LanceDB Timestamp字段无法直接在SQL中与整数字面值比较，必须在应用层过滤
  - 涉及Timestamp类型过滤时，应先查询完整数据集，再在JavaScript中进行范围判断
  - 总是检查 isNaN() 以防止无效值被拼接到SQL条件中

---
