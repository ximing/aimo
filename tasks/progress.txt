## 2026-02-19 - US-008 (Electron Client)
- Implement window state management using electron-store
- Add WindowState interface with x, y, width, height, isMaximized properties
- Create windowStore with electron-store for persistence (stored in userData)
- Implement saveWindowState() to save bounds and maximized state on window close
- Add display validation using screen.getAllDisplays() to ensure window is on valid monitor
- Restore saved bounds when creating window, fallback to defaults if display invalid
- Restore maximized state after window creation if previously maximized
- Save state both when hiding to tray (close button) and when actually quitting
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Added window state management with electron-store
- **Learnings for future iterations:**
  - electron-store automatically stores data in `app.getPath('userData')`/window-state.json
  - Always validate saved window bounds against available displays - monitors may be disconnected
  - Use `mainWindow.getBounds()` to get current position and size
  - Check `mainWindow.isMaximized()` before saving bounds - maximized bounds aren't useful for restoration
  - Import `screen` from electron to access display information
  - Store TypeScript interface helps ensure type safety for stored data
---

## 2026-02-19 - US-007 (Electron Client)
- Implement local file drag-and-drop support
- Add will-navigate handler to prevent page navigation on file drop
- Add drag-enter, drag-over, drop event handlers to webContents
- Filter dropped items to only include files using fs.statSync().isFile()
- Send file paths to renderer via IPC 'files-dropped' event
- Expose onFileDrop() and removeFileDropListener() in preload script with callbackMap
- Create isElectron.ts utility with isElectron(), getPlatform(), isMacOS(), isWindows(), isLinux()
- Add onFileDrop helper function for registering file drop callbacks
- Browser runs without errors when window.electronAPI is undefined
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Added drag/drop event handlers and will-navigate handler
  - `apps/client/src/preload/index.ts` - Added onFileDrop and removeFileDropListener APIs
  - `apps/web/src/electron/isElectron.ts` - New utility for Electron detection
- **Learnings for future iterations:**
  - Drag events on webContents are not fully typed in Electron - use @ts-expect-error
  - Use fs.statSync(filePath).isFile() to filter out directories from drop
  - Prevent file drop navigation with will-navigate handler checking for 'file://' URLs
  - IPC pattern for file drops: main webContents.on('drop') -> webContents.send() -> renderer onFileDrop()
  - Use separate callbackMap for different IPC events (messageCallbackMap, fileDropCallbackMap)
  - Browser compatibility: Always check isElectron() before accessing window.electronAPI
---

## 2026-02-19 - US-005 (Electron Client)
- Implement system-level global shortcuts
- Register CommandOrControl+Shift+A to toggle window visibility
- Add toggleWindowVisibility() helper function for reuse
- Add registerGlobalShortcuts() called on app ready
- Add will-quit handler to call globalShortcut.unregisterAll()
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Added globalShortcut import, toggleWindowVisibility(), registerGlobalShortcuts(), and will-quit handler
- **Learnings for future iterations:**
  - Use `globalShortcut.register()` with accelerator string like 'CommandOrControl+Shift+A'
  - Always unregister shortcuts on app quit to avoid conflicts
  - The toggle pattern: visible -> hide(), hidden -> show() + focus()
  - can check registration success with the boolean returned from register()
---

## 2026-02-19 - US-006 (Electron Client)
- Implement native application menu
- Add createApplicationMenu() function with platform-specific menus:
  - Edit menu: Undo, Redo, Cut, Copy, Paste, Select All
  - View menu: Reload, Toggle DevTools, Zoom controls, Fullscreen
  - Window menu: Minimize, Close, Show Main Window
  - macOS: App menu first with About, Hide, Hide Others, Quit
  - Windows/Linux: File menu with Quit option
  - Help menu with GitHub link
- Use MenuItemConstructorOptions type for menu items
- Use 'role' for standard actions to get native behavior and accelerators
- macOS role values: 'hide', 'hideOthers', 'unhide', 'front', 'togglefullscreen'
- Call Menu.setApplicationMenu(menu) to apply the menu
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Added createApplicationMenu() and Menu import
- **Learnings for future iterations:**
  - Use `role: 'hideOthers'` (camelCase) not 'hideothers' - TypeScript will catch this
  - Standard roles like 'undo', 'redo', 'cut', 'copy', 'paste' automatically get native accelerators
  - macOS requires app menu as first item with app name
  - Windows/Linux should have File menu with Quit option
  - Menu builds from template array of MenuItemConstructorOptions
---

## Codebase Patterns
- Use `electron-store` for persisting user preferences and window state to `app.getPath('userData')`
- Always validate saved window bounds against available displays using `screen.getAllDisplays()`
- Save window state on 'close' event before hiding or quitting
- Store both bounds (x, y, width, height) and isMaximized state separately
- When restoring, only apply bounds if the display is still valid (prevents off-screen windows)

- Use `routing-controllers` decorators (@Get, @Post, etc.) for API endpoints
- All services use TypeDI `@Service()` decorator for dependency injection
- Controllers return `ResponseUtil.success()` or `ResponseUtil.error()` for consistent responses
- LanceDB queries use `.where()` with SQL-like syntax for filtering
- User isolation: Every database operation must filter by `uid` for security
- Relations are stored in a separate `memo_relations` table with source/target memo IDs
- DTO types are defined in `packages/dto/src/` and shared between frontend/backend
- When adding controller endpoints, inject new services via constructor (TypeDI handles this automatically)
- Modal components use `@headlessui/react` Dialog and Transition for consistent UX
- Use `extractPlainText()` to strip markdown syntax for content previews
- File attachments: images/videos open preview modal, other files trigger download
- Responsive design: Use Tailwind responsive prefixes (sm:, md:, lg:) for adaptive layouts
- **Electron client:** Use `vite-plugin-electron` for main/preload build, contextBridge for API exposure
- **Electron patterns:** Store callbacks in Map for proper IPC listener removal, use `external: ['electron']` in rollupOptions
- **Electron web loading:** Dev mode loads from VITE_DEV_SERVER_URL (http://localhost:5173), production loads from `../server/public` (built by apps/web)
- **Electron tray:** Use `isQuiting` flag to distinguish between close-to-tray and actual quit

## 2026-02-19 - US-004 (Electron Client)
- Implement system tray functionality
- Close-to-tray behavior: intercept window 'close' event, prevent default and hide window
- Create Tray instance with context menu ("显示主窗口", "退出应用")
- Tray click toggles window visibility (show/hide)
- macOS dock activate restores hidden window
- Use `isQuiting` flag to handle quit vs hide-on-close distinction
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Added Tray, Menu imports, createTray function, close-to-tray handler
- **Learnings for future iterations:**
  - Use a module-level `isQuiting` variable to control close behavior (don't extend App interface - causes type errors)
  - Tray context menu built with `Menu.buildFromTemplate()`
  - On macOS, `app.on('activate')` handles dock icon clicks to restore window
  - Remove `window-all-closed` quit logic to keep app running in background with tray
---


## 2026-02-19 - US-002 (Electron Client)
- Update main process to load web app from correct paths
- Development mode: loads from VITE_DEV_SERVER_URL (http://localhost:5173 via vite-plugin-electron)
- Production mode: loads from `../server/public` (built web app output)
- Update electron-builder.yml to include `../../server/public` in packaged files
- Add `build:all` script to build web app, then client, then package
- Add eslint-disable comments for intentional environment variable usage
- Window configured with 1200x800 size, contextIsolation: true, nodeIntegration: false
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/src/main/index.ts` - Updated RENDERER_DIST path, added comments
  - `apps/client/electron-builder.yml` - Added server/public to files list
  - `apps/client/package.json` - Added build:all script
  - `turbo.json` - Added globalEnv for NODE_ENV
- **Learnings for future iterations:**
  - Web app builds to `../server/public` (not `dist` in apps/web)
  - Electron client must reference the correct build output path
  - Use `../../server/public` from apps/client perspective (goes to apps/server/public)
  - electron-builder files pattern uses relative paths from app directory
  - `build:all` script chains: web build → client build → electron-builder dist
---

## 2026-02-19 - US-001 (Electron Client)
- Initialize Electron project structure in apps/client
- Create main process (src/main/index.ts) with BrowserWindow configuration (1200x800)
- Create preload script (src/preload/index.ts) exposing electronAPI via contextBridge
- Configure Vite with vite-plugin-electron for main and preload builds
- Configure TypeScript with ES2022 target and strict mode
- Add pnpm dev:client and build:client commands to root package.json
- Configure electron-builder.yml for cross-platform packaging (mac/win/linux)
- Add ESLint config extending @aimo/eslint-config
- Typecheck and lint pass
- **Files changed:**
  - `apps/client/package.json` - New Electron project configuration
  - `apps/client/tsconfig.json` - TypeScript configuration
  - `apps/client/vite.config.ts` - Vite with vite-plugin-electron
  - `apps/client/electron-builder.yml` - Electron builder configuration
  - `apps/client/eslint.config.mjs` - ESLint configuration
  - `apps/client/src/main/index.ts` - Main process entry
  - `apps/client/src/preload/index.ts` - Preload script with contextBridge
  - `package.json` (root) - Added dev:client and build:client scripts
- **Learnings for future iterations:**
  - vite-plugin-electron simplifies Electron + Vite integration significantly
  - Use callbackMap to store wrapped IPC callbacks for proper listener removal
  - Preload script must use `contextIsolation: true` and `nodeIntegration: false` for security
  - APP_ROOT path calculation: `path.join(__dirname, '../..')` from dist/main/index.js
  - electron-builder config supports dmg/zip for mac, nsis/portable for win, AppImage/deb for linux
  - The `postinstall` electron-builder hook can fail in pnpm monorepos - better to run manually when needed
---

## 2026-02-18 - US-001
- 实现首页布局整体居中
- 添加外层居中容器包裹侧边栏和 memo 区域
- 侧边栏宽度保持 300px，memo 区域最大宽度保持 640px
- 响应式行为保持不变（窄屏时侧边栏收起）
- **Files changed:**
  - `apps/web/src/pages/home/home.tsx`
- **Learnings for future iterations:**
  - 布局结构：外层 `justify-center` 容器 + 内层 flex 容器实现整体居中
  - 响应式处理：通过 `isCompact || isCollapsed` 条件控制宽度为 `w-full` 或保持 `gap-6`
  - 注意 JSX 标签闭合，编辑时容易遗漏闭合标签
## 2026-02-18 - US-002
- 验证响应式交互保持不变
- US-001 的实现已保留所有响应式逻辑：
  - `isCompact` 状态通过 `HEATMAP_COMPACT_QUERY` 媒体查询控制
  - 窄屏时侧边栏自动收起 (`isCollapsed = true`)
  - 侧边栏在 `isCompact` 模式下作为绝对定位浮层显示
  - 展开/收起按钮交互保持不变
- **Files changed:**
  - 无新文件修改（已在 US-001 中实现）
- **Learnings for future iterations:**
  - 响应式逻辑通过 `window.matchMedia()` 和 React state 结合实现
  - 媒体查询 `(max-width: 1100px)` 作为断点控制侧边栏行为
---

## 2026-02-18 - US-002 (On This Day)
- 实现前端「历史的今天」横幅组件
- 添加 getOnThisDayMemos API 客户端方法
- 创建 OnThisDayBanner 组件：
  - 横向滚动布局，支持触摸滑动和鼠标滚轮
  - 显示时钟图标 + "历史的今天"标题
  - 每个卡片显示年份标签（蓝色badge）和内容预览（最多2行）
  - 无记录时自动隐藏整个区块
  - 最多显示5条，超出显示"查看更多"入口
- 集成到首页热力图下方、搜索栏上方
- 点击卡片可滚动到对应 memo 并高亮显示
- **Files changed:**
  - `apps/web/src/api/memo.ts` - 添加 getOnThisDayMemos API
  - `apps/web/src/pages/home/components/on-this-day-banner.tsx` - 新建横幅组件
  - `apps/web/src/pages/home/home.tsx` - 集成横幅到首页
- **Learnings for future iterations:**
  - 横向滚动实现：flex + overflow-x-auto + scrollbar-hide
  - 鼠标滚轮转横向滚动：onWheel 事件中修改 scrollLeft
  - 内容预览使用 line-clamp-2 限制行数
  - 使用 extractPlainText 函数去除 markdown 语法
  - 无记录时返回 null 自动隐藏组件
---

## 2026-02-18 - US-004 (On This Day)
- 实现响应式适配
- 更新卡片宽度响应式类：w-[160px] sm:w-[180px] md:w-[200px]
- 更新"查看更多"按钮宽度：w-[80px] sm:w-[90px] md:w-[100px]
- 更新详情弹窗内边距：px-4 sm:px-6
- 弹窗添加 mx-4 sm:mx-6 防止贴边
- **Files changed:**
  - `apps/web/src/pages/home/components/on-this-day-banner.tsx` - 响应式卡片宽度
  - `apps/web/src/pages/home/components/memo-detail-modal.tsx` - 响应式内边距
- **Learnings for future iterations:**
  - 使用 Tailwind 响应式前缀实现渐进增强
  - 移动端优先：基础样式为移动端，sm/md 为更大屏幕
  - 弹窗需要水平边距防止在小屏幕上贴边
---

## 2026-02-18 - US-003 (On This Day)
- 实现点击卡片查看 memo 详情功能
- 创建 MemoDetailModal 组件：
  - 使用 @headlessui/react Dialog 实现弹窗
  - 显示年份标签、完整内容、创建时间
  - 支持附件预览（图片/视频）和下载（文档）
  - 加载状态、错误处理
- 更新 OnThisDayBanner：
  - 点击卡片打开详情弹窗
  - 管理弹窗开关状态
- **Files changed:**
  - `apps/web/src/pages/home/components/memo-detail-modal.tsx` - 新建详情弹窗组件
  - `apps/web/src/pages/home/components/on-this-day-banner.tsx` - 集成弹窗交互
  - `apps/web/src/pages/home/home.tsx` - 移除未使用的 onMemoClick prop
- **Learnings for future iterations:**
  - 复用 AttachmentPreviewModal 组件处理附件预览
  - 使用 extractPlainText 统一处理 markdown 内容展示
  - 弹窗组件模式：isOpen/onClose props + 内部状态管理
  - 图片/视频点击预览，文档点击下载的交互模式
---

## 2026-02-18 - US-001 (On This Day)
- 实现后端 API 获取历史的今天 memos
- 创建 GET /api/v1/memos/on-this-day 端点
- 添加 OnThisDayMemoDto 和 OnThisDayResponseDto DTO 类型
- 实现 getOnThisDayMemos() 服务方法，筛选往年同月同日的 memos
- 排除当年记录，按年份倒序排列，最多返回 10 条
- **Files changed:**
  - `packages/dto/src/memo.ts` - 新增 DTO 类型
  - `apps/server/src/services/memo.service.ts` - 添加 getOnThisDayMemos 方法
  - `apps/server/src/controllers/v1/memo.controller.ts` - 添加 /on-this-day 端点
- **Learnings for future iterations:**
  - LanceDB 日期过滤：由于 Timestamp 类型无法直接与整数比较，需要在 JavaScript 中过滤日期
  - 使用 `new Date(createdAt)` 将时间戳转换为 Date 对象进行月份/日期比较
  - 注意 `getMonth()` 返回 0-11，`getDate()` 返回 1-31
  - DTO 变更后需要先 build dto 包，再运行 server typecheck
---

